<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - UniDesk</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Profile Specific Editorial Styles */
    .profile-header {
      background: white;
      padding: var(--spacing-lg) 20px;
      border-bottom: 2px solid var(--accent-tertiary);
      margin-bottom: var(--spacing-lg);
    }

    .profile-title-row {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .profile-title {
      font-family: var(--font-heading);
      font-size: 2.5rem;
      color: var(--accent-quaternary);
      /* Deep Red */
    }

    .save-status {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-family: var(--font-body);
      font-style: italic;
    }

    .profile-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px var(--spacing-xl);
    }

    .section-block {
      background: #fff;
      border: 1px solid var(--border-color);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      position: relative;
    }

    .section-block::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent-tertiary);
      /* Brown Left Border */
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .section-title {
      font-family: var(--font-heading);
      font-size: 1.5rem;
      color: var(--text-primary);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-base);
      /* Slight cream background for inputs */
      font-family: var(--font-body);
      font-size: 0.95rem;
      color: var(--text-primary);
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-quaternary);
      /* Red highlight on focus */
      background: #fff;
    }

    /* Dynamic Lists */
    .list-item {
      background: var(--bg-base);
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .list-item button.remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      color: var(--accent-quaternary);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .btn-action {
      background: white;
      border: 1px solid var(--accent-tertiary);
      color: var(--accent-tertiary);
      padding: 5px 15px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .btn-action:hover {
      background: var(--accent-tertiary);
      color: white;
    }
  </style>
</head>

<body>
  <nav class="main-nav navbar">
    <div class="container flex justify-between items-center" style="width:100%">
      <div class="brand-logo">UniDesk</div>
      <ul class="nav-links">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="projects.html" class="nav-link">Projects</a></li>
        <li><a href="aboutus.html" class="nav-link">About Us</a></li>
        <li><a href="profile.html" class="nav-link" style="border-bottom: 2px solid var(--accent-quaternary);">Team</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Profile Header -->
  <div class="profile-header">
    <div class="profile-title-row">
      <h1 class="profile-title">Professional Profile</h1>
      <div style="display:flex; gap:10px; align-items:center;">
        <span id="autosaveStatus" class="save-status">All changes saved</span>
        <button class="btn" id="saveProfileBtn">Save Changes</button>
        <button class="btn-secondary" id="generateResumeBtn" style="padding:10px 20px;">ðŸ“„ Resume</button>
      </div>
    </div>
  </div>

  <div class="profile-content">

    <!-- 1. Basic Info -->
    <div class="section-block">
      <div class="section-header">
        <h2 class="section-title">01. Basic Information</h2>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Full Name</label><input type="text" id="fullName"></div>
        <div class="form-group"><label>Designation</label><input type="text" id="designation"></div>
        <div class="form-group"><label>Department</label><input type="text" id="department"></div>
        <div class="form-group"><label>Institution</label><input type="text" id="institution"></div>
        <div class="form-group" style="grid-column:1/-1;"><label>Office Address</label><textarea id="officeAddress"
            rows="2"></textarea></div>
        <div class="form-group"><label>Email</label><input type="email" id="officialEmail"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="phone"></div>
        <div class="form-group" style="grid-column:1/-1;"><label>Website</label><input type="url" id="website"></div>
      </div>
    </div>

    <!-- 2. Employment -->
    <div class="section-block">
      <div class="section-header">
        <h2 class="section-title">02. Employment History</h2>
        <button class="btn-action" id="addEmploymentBtn">+ Add Position</button>
      </div>
      <div id="employmentList"></div>
    </div>

    <!-- 3. Education -->
    <div class="section-block">
      <div class="section-header">
        <h2 class="section-title">03. Academic Background</h2>
        <button class="btn-action" id="addDegreeBtn">+ Add Degree</button>
      </div>
      <div id="degreesList"></div>
    </div>

    <!-- 4. Research -->
    <div class="section-block">
      <div class="section-header">
        <h2 class="section-title">04. Research</h2>
      </div>
      <div class="form-group"><label>Keywords</label><input type="text" id="researchKeywords"
          placeholder="e.g. AI, Data Science"></div>
      <div class="form-group"><label>Description</label><textarea id="researchDescription" rows="4"></textarea></div>
    </div>

    <!-- 5. Publications -->
    <div class="section-block">
      <div class="section-header">
        <h2 class="section-title">05. Publications</h2>
      </div>
      <div class="form-group"><label>Google Scholar Link</label><input type="url" id="scholarLink"></div>
    </div>

    <!-- 6. Awards -->
    <div class="section-block">
      <div class="section-header">
        <h2 class="section-title">06. Awards</h2>
        <button class="btn-action" id="addAwardBtn">+ Add Award</button>
      </div>
      <div id="awardsList"></div>
    </div>

  </div>

  <script>
    const API_BASE = window.location.origin;
    const userEmail = sessionStorage.getItem('userEmail');
    if (!userEmail) window.location.href = 'index.html';

    let autosaveTimeout;

    // --- Helpers ---
    function createField(type, val = '', placeholder = '', key = '') {
      if (type === 'textarea') return `<textarea class="autosave-field" data-key="${key}" placeholder="${placeholder}">${val}</textarea>`;
      return `<input class="autosave-field" data-key="${key}" value="${val}" placeholder="${placeholder}" />`;
    }

    function createListItem(type, data = {}) {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `<button class="remove-btn">Ã—</button><div class="form-grid"></div>`;

      const grid = div.querySelector('.form-grid');

      if (type === 'employment') {
        grid.innerHTML = `
                <div class="form-group"><label>Role</label>${createField('text', data.position, 'Role', 'position')}</div>
                <div class="form-group"><label>Org</label>${createField('text', data.organization, 'Organization', 'organization')}</div>
                <div class="form-group"><label>Duration</label>${createField('text', data.duration, '2020-2022', 'duration')}</div>
            `;
      } else if (type === 'degree') {
        grid.innerHTML = `
                <div class="form-group"><label>Degree</label>${createField('text', data.degree, 'PhD', 'degree')}</div>
                <div class="form-group"><label>Inst</label>${createField('text', data.institution, 'University', 'institution')}</div>
                <div class="form-group"><label>Year</label>${createField('text', data.year, '2023', 'year')}</div>
            `;
      } else if (type === 'award') {
        grid.innerHTML = `
                <div class="form-group"><label>Title</label>${createField('text', data.title, 'Award Title', 'title')}</div>
                <div class="form-group"><label>Year</label>${createField('text', data.year, '2022', 'year')}</div>
            `;
      } // ... add others as needed (courses/grants omitted for brevity but logic is same)

      div.querySelector('.remove-btn').onclick = () => { div.remove(); triggerAutosave(); };
      div.querySelectorAll('input, textarea').forEach(i => i.oninput = triggerAutosave);
      return div;
    }

    // --- Logic ---
    function triggerAutosave() {
      document.getElementById('autosaveStatus').textContent = 'Saving...';
      clearTimeout(autosaveTimeout);
      autosaveTimeout = setTimeout(saveProfile, 1500);
    }

    async function saveProfile() {
      const data = {
        userEmail,
        fullName: document.getElementById('fullName').value,
        designation: document.getElementById('designation').value,
        department: document.getElementById('department').value,
        institution: document.getElementById('institution').value,
        officeAddress: document.getElementById('officeAddress').value,
        officialEmail: document.getElementById('officialEmail').value,
        phone: document.getElementById('phone').value,
        website: document.getElementById('website').value,
        researchKeywords: document.getElementById('researchKeywords').value,
        researchDescription: document.getElementById('researchDescription').value,
        scholarLink: document.getElementById('scholarLink').value,

        employment: getListData('employmentList'),
        degrees: getListData('degreesList'),
        awards: getListData('awardsList')
      };

      try {
        await fetch(`${API_BASE}/profile`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        document.getElementById('autosaveStatus').textContent = 'All changes saved';
      } catch (e) {
        document.getElementById('autosaveStatus').textContent = 'Error saving';
      }
    }

    function getListData(id) {
      return Array.from(document.querySelectorAll(`#${id} .list-item`)).map(item => {
        const obj = {};
        item.querySelectorAll('[data-key]').forEach(i => obj[i.dataset.key] = i.value);
        return obj;
      });
    }

    async function load() {
      try {
        const res = await fetch(`${API_BASE}/profile/${encodeURIComponent(userEmail)}`);
        const d = await res.json();
        if (!d) return;

        ['fullName', 'designation', 'department', 'institution', 'officeAddress', 'officialEmail', 'phone', 'website', 'researchKeywords', 'researchDescription', 'scholarLink'].forEach(k => {
          if (document.getElementById(k)) document.getElementById(k).value = d[k] || '';
        });

        (d.employment || []).forEach(x => document.getElementById('employmentList').appendChild(createListItem('employment', x)));
        (d.degrees || []).forEach(x => document.getElementById('degreesList').appendChild(createListItem('degree', x)));
        (d.awards || []).forEach(x => document.getElementById('awardsList').appendChild(createListItem('award', x)));

      } catch (e) { }
    }

    // --- Init ---
    document.querySelectorAll('input, textarea').forEach(i => i.oninput = triggerAutosave);
    document.getElementById('saveProfileBtn').onclick = saveProfile;

    document.getElementById('addEmploymentBtn').onclick = () => {
      document.getElementById('employmentList').appendChild(createListItem('employment'));
    };
    document.getElementById('addDegreeBtn').onclick = () => {
      document.getElementById('degreesList').appendChild(createListItem('degree'));
    };
    document.getElementById('addAwardBtn').onclick = () => {
      document.getElementById('awardsList').appendChild(createListItem('award'));
    };

    load();
  </script>
</body>

</html>