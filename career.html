<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Career & Goals - UniDesk</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Career Specific Styles */
    .career-header {
      background: #fff;
      padding: var(--spacing-lg) 20px;
      border-bottom: 2px solid var(--accent-tertiary);
      margin-bottom: var(--spacing-md);
    }

    .page-title {
      font-family: var(--font-heading);
      font-size: 2.5rem;
      color: var(--text-primary);
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      padding: 0 20px;
      max-width: 1400px;
      margin: 0 auto 30px;
    }

    .stat-card {
      background: #fff;
      padding: 20px;
      border: 1px solid var(--border-color);
      border-left: 4px solid var(--accent-tertiary);
      box-shadow: var(--shadow-soft);
    }

    .stat-val {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-tertiary);
    }

    .stat-lbl {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .goals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: var(--spacing-md);
      padding: 0 20px var(--spacing-xl);
      max-width: 1400px;
      margin: 0 auto;
    }

    .goal-card {
      background: #fff;
      border: 1px solid var(--border-color);
      padding: 25px;
      position: relative;
      transition: var(--transition-smooth);
    }

    .goal-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    .goal-title {
      font-family: var(--font-heading);
      font-size: 1.4rem;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .progress-bar-bg {
      width: 100%;
      height: 8px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--accent-tertiary);
      width: 0%;
      transition: width 0.5s ease;
    }

    /* Reuse Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(23, 58, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(3px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: #fff;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      border-top: 5px solid var(--accent-tertiary);
    }
  </style>
</head>

<body>
  <nav class="main-nav navbar">
    <div class="container flex justify-between items-center" style="width:100%">
      <div class="brand-logo">UniDesk</div>
      <ul class="nav-links">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="projects.html" class="nav-link">Projects</a></li>
        <li><a href="aboutus.html" class="nav-link">About Us</a></li>
        <li><a href="profile.html" class="nav-link">Profile</a></li>
      </ul>
    </div>
  </nav>

  <div class="career-header">
    <div class="container" style="max-width:1400px; padding:0;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 class="page-title">Career Trajectory</h1>
        <button class="btn" style="background:var(--accent-tertiary);" onclick="openNewGoalModal()">+ New Goal</button>
      </div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-val" id="totalGoals">0</div>
      <div class="stat-lbl">Total Goals</div>
    </div>
    <div class="stat-card">
      <div class="stat-val" id="completedGoals">0</div>
      <div class="stat-lbl">Completed</div>
    </div>
    <div class="stat-card">
      <div class="stat-val" id="avgProgress">0%</div>
      <div class="stat-lbl">Avg Progress</div>
    </div>
  </div>

  <div class="container" style="max-width:1400px; padding:0 20px 20px;">
    <select id="typeFilter" onchange="renderGoals()"
      style="padding:8px; border:1px solid var(--border-color); width:200px;">
      <option value="all">All Types</option>
      <option value="research">Research</option>
      <option value="teaching">Teaching</option>
      <option value="publication">Publication</option>
    </select>
  </div>

  <div class="goals-grid" id="goalsGrid">
    <!-- Generated by JS -->
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="goalModal">
    <div class="modal-content">
      <h2 id="modalTitle" style="font-family:var(--font-heading); margin-bottom:20px;">Goal Details</h2>

      <form id="goalForm" onsubmit="saveGoal(event)">
        <div style="margin-bottom:15px;">
          <label style="font-weight:bold;">Title</label>
          <input type="text" id="goalTitle" required
            style="width:100%; padding:10px; border:1px solid var(--border-color);">
        </div>
        <div style="margin-bottom:15px;">
          <label style="font-weight:bold;">Type</label>
          <select id="goalType" style="width:100%; padding:10px; border:1px solid var(--border-color);">
            <option value="research">Research</option>
            <option value="teaching">Teaching</option>
            <option value="publication">Publication</option>
            <option value="general">General</option>
          </select>
        </div>
        <div style="margin-bottom:15px;">
          <label style="font-weight:bold;">Progress (<span id="progVal">0</span>%)</label>
          <input type="range" id="goalProgress" min="0" max="100" value="0" style="width:100%;"
            oninput="document.getElementById('progVal').innerText=this.value">
        </div>
        <div style="margin-bottom:15px;">
          <label style="font-weight:bold;">Description</label>
          <textarea id="goalDesc" rows="3"
            style="width:100%; padding:10px; border:1px solid var(--border-color);"></textarea>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
          <button type="button" class="btn-outline" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn" style="background:var(--accent-tertiary);">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const userEmail = sessionStorage.getItem('userEmail');
    if (!userEmail) window.location.href = 'index.html';

    let goals = [];
    let editingId = null;

    document.addEventListener('DOMContentLoaded', loadGoals);

    async function loadGoals() {
      try {
        const res = await fetch(`${API_BASE}/career/${encodeURIComponent(userEmail)}`);
        if (res.ok) {
          goals = await res.json();
          renderGoals();
          updateStats();
        }
      } catch (e) { console.error(e); }
    }

    function renderGoals() {
      const grid = document.getElementById('goalsGrid');
      const type = document.getElementById('typeFilter').value;

      const filtered = type === 'all' ? goals : goals.filter(g => g.type === type);

      if (!filtered.length) {
        grid.innerHTML = '<div style="text-align:center; grid-column:1/-1;">No goals found</div>';
        return;
      }

      grid.innerHTML = filtered.map(g => `
              <div class="goal-card" onclick="editGoal(${g.id})">
                  <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                      <div class="goal-title">${g.title}</div>
                      <span style="font-size:0.8rem; background:#f4f4f4; padding:2px 8px; border-radius:4px;">${g.type}</span>
                  </div>
                  <div class="progress-bar-bg">
                      <div class="progress-bar-fill" style="width:${g.progress}%"></div>
                  </div>
                  <div style="display:flex; justify-content:space-between; font-size:0.85rem; color:var(--text-secondary);">
                      <span>${g.progress}% Complete</span>
                      <span>${new Date(g.created_date).toLocaleDateString()}</span>
                  </div>
              </div>
          `).join('');
    }

    function updateStats() {
      document.getElementById('totalGoals').innerText = goals.length;
      document.getElementById('completedGoals').innerText = goals.filter(g => g.progress == 100).length;
      const avg = goals.length ? Math.round(goals.reduce((a, b) => a + (parseInt(b.progress) || 0), 0) / goals.length) : 0;
      document.getElementById('avgProgress').innerText = avg + '%';
    }

    // Modal
    function openNewGoalModal() {
      editingId = null;
      document.getElementById('goalForm').reset();
      document.getElementById('progVal').innerText = '0';
      document.getElementById('modalTitle').innerText = 'New Goal';
      document.getElementById('goalModal').classList.add('active');
    }

    function editGoal(id) {
      const g = goals.find(x => x.id === id);
      if (!g) return;
      editingId = id;
      document.getElementById('goalTitle').value = g.title;
      document.getElementById('goalType').value = g.type;
      document.getElementById('goalProgress').value = g.progress;
      document.getElementById('progVal').innerText = g.progress;
      document.getElementById('goalDesc').value = g.description;
      document.getElementById('modalTitle').innerText = 'Edit Goal';
      document.getElementById('goalModal').classList.add('active');
    }

    function closeModal() { document.getElementById('goalModal').classList.remove('active'); }

    async function saveGoal(e) {
      e.preventDefault();
      const data = {
        userEmail,
        title: document.getElementById('goalTitle').value,
        type: document.getElementById('goalType').value,
        progress: document.getElementById('goalProgress').value,
        description: document.getElementById('goalDesc').value
      };

      const url = editingId ? `${API_BASE}/career/${editingId}` : `${API_BASE}/career`;
      const method = editingId ? 'PUT' : 'POST';

      try {
        await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        closeModal();
        loadGoals();
      } catch (e) { alert('Error saving'); }
    }
  </script>
</body>

</html>