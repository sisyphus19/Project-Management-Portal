<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Dashboard - UniDesk</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Dashboard specific overrides */

    .dashboard-header {
      margin: var(--spacing-xl) 0 var(--spacing-lg);
      text-align: center;
      animation: fadeIn 0.6s ease-out;
    }

    .welcome-text {
      font-family: var(--font-heading);
      font-size: 2.5rem;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .date-display {
      font-size: 1rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      animation: fadeIn 0.8s ease-out;
    }

    /* Tile enhancements */
    .dashboard-tile {
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #FFFFFF;
      border: 1px solid #E0DCCD;
      transition: all 0.4s ease;
    }

    .dashboard-tile:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      border-color: var(--accent-primary);
    }

    .tile-header {
      margin-bottom: var(--spacing-md);
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: var(--spacing-sm);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tile-title {
      font-family: var(--font-heading);
      font-size: 1.5rem;
      margin: 0;
      color: var(--text-primary);
    }

    .tile-icon {
      font-size: 1.2rem;
      color: var(--accent-primary);
    }

    .tile-content {
      flex: 1;
      min-height: 150px;
    }

    .tile-item {
      padding: 10px 0;
      border-bottom: 1px solid #f9f9f9;
      font-size: 0.95rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
    }

    .tile-item:last-child {
      border-bottom: none;
    }

    .tile-item::before {
      content: '‚Ä¢';
      color: var(--accent-secondary);
      margin-right: 8px;
      font-size: 1.2em;
    }

    .tile-footer {
      margin-top: var(--spacing-md);
    }

    .tile-button {
      width: 100%;
      text-align: center;
      color: var(--accent-primary);
      font-weight: 700;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      background: transparent;
      border: 1px solid rgba(27, 63, 45, 0.2);
      padding: 10px;
      transition: var(--transition-smooth);
      border-radius: 4px;
    }

    .tile-button:hover {
      background: var(--accent-primary);
      color: #fff;
      border-color: var(--accent-primary);
    }

    /* Loading/Empty states */
    .loading,
    .empty-state {
      color: var(--text-secondary);
      font-style: italic;
      text-align: center;
      padding: 20px 0;
      font-size: 0.9rem;
    }

    .error {
      color: #d32f2f;
      text-align: center;
      font-size: 0.9rem;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="main-nav">
    <div class="brand-logo">UniDesk</div>
    <ul class="nav-links">
      <li><a href="dashboard.html" class="nav-link"
          style="border-bottom: 1px solid var(--accent-secondary);">Dashboard</a></li>
      <li><a href="projects.html" class="nav-link">Projects</a></li>
      <li><a href="profile.html" class="nav-link">Team</a></li>
      <li><a href="#" class="nav-link">Reports</a></li>
      <li><a href="#" class="nav-link" id="logoutBtn">Logout</a></li>
    </ul>
  </nav>

  <div class="container">
    <header class="dashboard-header">
      <h1 class="welcome-text">Overview</h1>
      <p class="date-display" id="currentDate"></p>
    </header>

    <div class="dashboard-grid">
      <!-- Projects -->
      <div class="card dashboard-tile projects" data-tile="projects">
        <div class="tile-header">
          <div class="tile-icon">üöÄ</div>
          <h3 class="tile-title">Projects</h3>
        </div>
        <div class="tile-content" id="projects-content">
          <div class="loading">Loading...</div>
        </div>
        <div class="tile-footer">
          <button class="tile-button">View All</button>
        </div>
      </div>

      <!-- Ideas -->
      <div class="card dashboard-tile ideas" data-tile="ideas">
        <div class="tile-header">
          <div class="tile-icon">üí°</div>
          <h3 class="tile-title">Ideas</h3>
        </div>
        <div class="tile-content" id="ideas-content">
          <div class="loading">Loading...</div>
        </div>
        <div class="tile-footer">
          <button class="tile-button">Manage</button>
        </div>
      </div>

      <!-- Notes -->
      <div class="card dashboard-tile notes" data-tile="notes">
        <div class="tile-header">
          <div class="tile-icon">üìù</div>
          <h3 class="tile-title">Notes</h3>
        </div>
        <div class="tile-content" id="notes-content">
          <div class="loading">Loading...</div>
        </div>
        <div class="tile-footer">
          <button class="tile-button">Save Note</button>
        </div>
      </div>

      <!-- Deadlines -->
      <div class="card dashboard-tile deadlines" data-tile="deadlines">
        <div class="tile-header">
          <div class="tile-icon">‚è∞</div>
          <h3 class="tile-title">Deadlines</h3>
        </div>
        <div class="tile-content" id="deadlines-content">
          <div class="loading">Loading...</div>
        </div>
        <div class="tile-footer">
          <button class="tile-button">View All</button>
        </div>
      </div>

      <!-- Future -->
      <div class="card dashboard-tile future" data-tile="future">
        <div class="tile-header">
          <div class="tile-icon">üîÆ</div>
          <h3 class="tile-title">Future</h3>
        </div>
        <div class="tile-content" id="future-content">
          <div class="loading">Loading...</div>
        </div>
        <div class="tile-footer">
          <button class="tile-button">Plan</button>
        </div>
      </div>

      <!-- Career -->
      <div class="card dashboard-tile career" data-tile="career">
        <div class="tile-header">
          <div class="tile-icon">üéØ</div>
          <h3 class="tile-title">Goals</h3>
        </div>
        <div class="tile-content" id="career-content">
          <div class="loading">Loading...</div>
        </div>
        <div class="tile-footer">
          <button class="tile-button">Track</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===================== API CONFIGURATION =====================
    const API_BASE = window.location.origin;

    // ===================== AUTHENTICATION =====================
    function getCurrentUser() {
      return sessionStorage.getItem('userEmail');
    }

    function isUserLoggedIn() {
      return sessionStorage.getItem('isLoggedIn') === 'true';
    }

    function redirectToLogin() {
      alert('Please log in to access this page');
      window.location.href = 'index.html'; // Changed from '/' to index.html for safety
    }

    // Check authentication
    if (!isUserLoggedIn()) {
      redirectToLogin();
    }

    const userEmail = getCurrentUser();
    if (!userEmail) {
      redirectToLogin();
    }

    // ===================== API HELPERS =====================
    async function apiCall(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'API call failed');
        }

        return data;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // ===================== DATABASE INTEGRATION =====================
    async function loadTileData(tileType) {
      try {
        const data = await apiCall(`/${tileType}/${encodeURIComponent(userEmail)}`);
        return data;
      } catch (error) {
        console.error(`Failed to load ${tileType}:`, error);
        return [];
      }
    }

    // ===================== DASHBOARD RENDERING =====================
    function renderTile(tileType) {
      loadTileData(tileType).then(data => {
        const contentEl = document.getElementById(`${tileType}-content`);

        if (data.length === 0) {
          contentEl.innerHTML = `<div class="empty-state">No items yet</div>`;
          return;
        }

        // Show top 3 items
        const topItems = data.slice(0, 3);
        contentEl.innerHTML = topItems.map(item => {
          let displayText = item.title || item.name || item.content || item.description || '';

          switch (tileType) {
            case 'deadlines':
              if (item.due_date) {
                const daysLeft = Math.ceil((new Date(item.due_date) - new Date()) / (1000 * 60 * 60 * 24));
                displayText += ` <span style="color: ${daysLeft <= 0 ? '#ef4444' : 'var(--text-secondary)'}; font-size: 0.8rem;">(${daysLeft > 0 ? daysLeft + ' days' : 'overdue'})</span>`;
              }
              break;
            case 'ideas':
              if (item.category) displayText += ` <span style="font-size: 0.8rem; margin-left: 5px; opacity: 0.7;">[${item.category}]</span>`;
              break;
            case 'future':
              if (item.timeline) displayText += ` <span style="font-size: 0.8rem; margin-left: 5px; opacity: 0.7;">(${item.timeline})</span>`;
              break;
          }

          return `<div class="tile-item">${displayText}</div>`;
        }).join('');

        if (data.length > 3) {
          contentEl.innerHTML += `<div class="empty-state" style="padding: 5px; font-size: 0.8rem;">+${data.length - 3} more</div>`;
        }
      }).catch(error => {
        const contentEl = document.getElementById(`${tileType}-content`);
        contentEl.innerHTML = `<div class="error">Load failed</div>`;
      });
    }

    function initializeDashboard() {
      const tileTypes = ['deadlines', 'ideas', 'projects', 'notes', 'career', 'future'];
      tileTypes.forEach(renderTile);

      // Set Date
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', dateOptions);
    }

    // ===================== INTERACTION =====================
    // Logout
    document.getElementById("logoutBtn").onclick = (e) => {
      e.preventDefault();
      sessionStorage.removeItem("userEmail");
      sessionStorage.removeItem("isLoggedIn");
      window.location.href = "index.html";
    };

    // Tile clicks
    document.querySelectorAll('.dashboard-tile').forEach(tile => {
      tile.addEventListener('click', (e) => {
        // Prevent click if clicking button
        if (e.target.tagName === 'BUTTON') return;

        const tileType = tile.dataset.tile;
        sessionStorage.setItem('activeTile', tileType);

        // Mapping simple check
        const pages = {
          'ideas': 'ideas.html',
          'notes': 'notes.html',
          'projects': 'projects.html',
          'deadlines': 'deadlines.html',
          'career': 'career.html',
          'future': 'future.html'
        };

        if (pages[tileType]) {
          window.location.href = pages[tileType];
        } else {
          alert('Coming soon: ' + tileType);
        }
      });

      // Button clicks inside tiles
      const btn = tile.querySelector('.tile-button');
      if (btn) {
        btn.addEventListener('click', (e) => {
          e.stopPropagation(); // Avoid double event
          const tileType = tile.dataset.tile;
          const pages = {
            'ideas': 'ideas.html',
            'notes': 'notes.html',
            'projects': 'projects.html',
            'deadlines': 'deadlines.html',
            'career': 'career.html',
            'future': 'future.html'
          };
          if (pages[tileType]) window.location.href = pages[tileType];
        });
      }
    });

    initializeDashboard();

  </script>
</body>

</html>