<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Projects - UniDesk</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Projects Specific Styles */
    .page-header {
      text-align: center;
      margin: var(--spacing-xl) 0 var(--spacing-lg);
      animation: fadeIn 0.6s ease-out;
    }

    .page-title {
      font-family: var(--font-heading);
      font-size: 2.5rem;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .page-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      flex-wrap: wrap;
      gap: 20px;
    }

    .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: var(--spacing-lg);
      padding-bottom: var(--spacing-xl);
    }

    .project-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: var(--spacing-md);
      transition: var(--transition-smooth);
      position: relative;
      overflow: hidden;
    }

    .project-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
      border-color: var(--accent-tertiary);
    }

    .project-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--accent-tertiary);
      /* Earthy Brown Top Border */
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }

    .project-card:hover::before {
      transform: scaleX(1);
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: var(--spacing-md);
    }

    .project-title {
      font-family: var(--font-heading);
      font-size: 1.25rem;
      color: var(--text-primary);
      margin: 0;
    }

    .project-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
    }

    /* Progress Bar */
    .progress-container {
      height: 4px;
      background: #f0f0f0;
      border-radius: 2px;
      margin: var(--spacing-sm) 0;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: var(--accent-secondary);
      border-radius: 2px;
    }

    .team-section {
      margin-top: var(--spacing-md);
      border-top: 1px solid #f5f5f5;
      padding-top: var(--spacing-sm);
    }

    .team-avatar {
      display: inline-block;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent-tertiary);
      color: #fff;
      text-align: center;
      line-height: 28px;
      font-size: 0.75rem;
      margin-right: -8px;
      border: 2px solid #fff;
    }

    .action-row {
      margin-top: var(--spacing-md);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-sm {
      padding: 6px 16px;
      font-size: 0.75rem;
      border-radius: 2px;
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(23, 58, 42, 0.4);
      /* Dark Evergreen tint */
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: var(--bg-card);
      padding: 40px;
      border: 1px solid var(--border-color);
      width: 100%;
      max-width: 500px;
      border-radius: 2px;
      box-shadow: var(--shadow-hover);
      animation: fadeIn 0.3s ease-out;
    }

    /* Search Bar Styled */
    #searchBar {
      max-width: 300px;
      border: none;
      border-bottom: 2px solid var(--border-color);
      background: transparent;
      padding: 8px 0;
      border-radius: 0;
    }

    #searchBar:focus {
      border-color: var(--accent-tertiary);
      box-shadow: none;
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="main-nav navbar">
    <div class="container flex justify-between items-center" style="width:100%">
      <div class="brand-logo">UniDesk</div>
      <ul class="nav-links">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="projects.html" class="nav-link"
            style="border-bottom: 1px solid var(--accent-quaternary);">Projects</a></li>
        <li><a href="profile.html" class="nav-link">Team</a></li>
        <li><a href="#" class="nav-link">Reports</a></li>
        <li><a href="#" class="nav-link" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <header class="page-header">
      <h1 class="page-title">Projects</h1>
      <p>Manage your initiatives and track progress.</p>
    </header>

    <div class="page-controls">
      <input type="text" id="searchBar" placeholder="Search projects...">
      <button id="addProjectBtn" class="btn">+ New Project</button>
    </div>

    <div id="loadingProjects" class="text-center" style="display:none; color: var(--text-secondary);">Loading...</div>
    <div id="errorProjects" class="text-center" style="display:none; color: var(--accent-quaternary);">Failed to load
      projects.</div>

    <div id="projectsContainer" class="project-grid">
      <!-- Projects will be injected here -->
    </div>
  </div>

  <!-- Add Project Modal -->
  <div class="modal" id="projectModal">
    <div class="modal-content">
      <h3 style="margin-bottom: 20px;">New Project</h3>
      <div style="margin-bottom: 15px;">
        <label style="display:block; margin-bottom:5px; font-size:0.9rem;">Project Name</label>
        <input id="projectName" type="text" placeholder="e.g. Website Redesign" />
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display:block; margin-bottom:5px; font-size:0.9rem;">Initial Progress: <span
            id="newProjectProgress">0</span>%</label>
        <input type="range" id="newProgressSlider" min="0" max="100" value="0" style="width:100%" />
      </div>

      <h4 style="font-size:1rem; margin-bottom:10px;">Team Members</h4>
      <div id="colleaguesInputs" style="margin-bottom:10px;">
        <div class="colleague-row Flex gap-2" style="display:flex; gap:10px; margin-bottom:10px;">
          <input placeholder="Name" class="colName" />
          <input placeholder="Email" class="colEmail" type="email" />
        </div>
      </div>
      <button id="addColleagueBtn" class="btn-secondary"
        style="font-size:0.8rem; padding: 5px 10px; margin-bottom: 20px;">+ Add Member</button>

      <div class="flex justify-between" style="border-top:1px solid #eee; padding-top:20px;">
        <button id="closeModalBtn" class="btn-secondary" style="border:none;">Cancel</button>
        <button id="saveProjectBtn" class="btn">Create Project</button>
      </div>
    </div>
  </div>

  <!-- Edit Project Modal -->
  <div class="modal" id="editProjectModal">
    <div class="modal-content">
      <h3 style="margin-bottom: 20px;">Edit Project</h3>
      <div style="margin-bottom: 15px;">
        <label>Project Name</label>
        <input id="editProjectName" type="text" />
      </div>

      <div style="margin-bottom: 20px;">
        <label>Progress: <span id="editProjectProgress">0</span>%</label>
        <input type="range" id="editProgressSlider" min="0" max="100" value="0" style="width:100%" />
      </div>

      <h4>Team Members</h4>
      <div id="editColleaguesInputs" style="margin-bottom:10px;"></div>
      <button id="editAddColleagueBtn" class="btn-secondary"
        style="font-size:0.8rem; padding: 5px 10px; margin-bottom: 20px;">+ Add Member</button>

      <div class="flex justify-between" style="border-top:1px solid #eee; padding-top:20px;">
        <div>
          <button id="deleteProjectBtn"
            style="color:var(--accent-quaternary); background:none; border:none; cursor:pointer; font-weight:700;">Delete</button>
        </div>
        <div style="display:flex; gap:10px;">
          <button id="closeEditModalBtn" class="btn-secondary" style="border:none;">Cancel</button>
          <button id="updateProjectBtn" class="btn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Meetings Modal -->
  <div class="modal" id="meetingsModal">
    <div class="modal-content">
      <h3 style="margin-bottom: 15px;">Meeting Timeline</h3>
      <div id="meetingsList"
        style="max-height:250px; overflow-y:auto; margin-bottom:20px; border:1px solid #eee; padding:10px;"></div>

      <h4 style="font-size:0.9rem; margin-bottom:10px;">Record New Meeting</h4>
      <input type="date" id="meetingDate" style="margin-bottom:10px;" />
      <textarea id="meetingDesc" placeholder="Notes..." rows="3"
        style="width:100%; padding:10px; border:1px solid var(--border-color); margin-bottom:10px;"></textarea>

      <div class="flex justify-between" style="border-top:1px solid #eee; padding-top:20px;">
        <button id="closeMeetingsModalBtn" class="btn-secondary" style="border:none;">Close</button>
        <button id="addMeetingBtn" class="btn">Add Note</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    // --- Auth Check ---
    if (sessionStorage.getItem('isLoggedIn') !== 'true' || !sessionStorage.getItem('userEmail')) {
      alert('Please log in.');
      window.location.href = 'index.html';
    }
    const userEmail = sessionStorage.getItem('userEmail');

    // --- State ---
    let projects = [];
    let editingProjectId = null;
    let currentColleagueEmail = null;

    // --- Elements ---
    const container = document.getElementById("projectsContainer");
    const searchBar = document.getElementById("searchBar");

    // --- API Helper ---
    async function apiCall(endpoint, options = {}) {
      try {
        const res = await fetch(`${API_BASE}${endpoint}`, {
          headers: { 'Content-Type': 'application/json', ...options.headers },
          ...options
        });
        if (!res.ok) throw new Error('API Failed');
        return await res.json();
      } catch (e) {
        console.error(e);
        throw e;
      }
    }

    // --- Load Projects ---
    async function loadProjects() {
      document.getElementById('loadingProjects').style.display = 'block';
      container.innerHTML = '';
      try {
        const data = await apiCall(`/projects/${encodeURIComponent(userEmail)}`);
        projects = data;
        renderProjects();
      } catch (e) {
        document.getElementById('errorProjects').style.display = 'block';
      } finally {
        document.getElementById('loadingProjects').style.display = 'none';
      }
    }

    // --- Render ---
    function renderProjects(filter = '') {
      const filtered = projects.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
      container.innerHTML = '';

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center" style="grid-column: 1/-1; padding: 40px; color: var(--text-secondary);">No projects found. Use "+ New Project" to create one.</div>';
        return;
      }

      filtered.forEach(p => {
        const progress = p.progress || 0;
        let colleagues = [];
        try { colleagues = typeof p.colleagues === 'string' ? JSON.parse(p.colleagues) : p.colleagues || []; } catch (e) { }

        const card = document.createElement('div');
        card.className = 'project-card';
        card.innerHTML = `
                <div class="project-header">
                    <h3 class="project-title">${p.name}</h3>
                    <span style="font-size:0.8rem; font-weight:700; color:var(--accent-secondary);">${progress}%</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" style="width: ${progress}%"></div>
                </div>
                
                <div class="team-section">
                    <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:5px;">Team</div>
                    <div>
                        ${colleagues.length ? colleagues.map(c => `
                            <span class="team-avatar" title="${c.name} (${c.email})">${c.name.charAt(0)}</span>
                        `).join('') : '<span style="font-style:italic; font-size:0.8rem; color:#aaa;">No members</span>'}
                    </div>
                </div>

                <div class="action-row">
                    <button class="btn-secondary btn-sm edit-btn" data-id="${p.id}">Edit</button>
                    ${colleagues.length ? `<button class="btn-secondary btn-sm team-btn" data-id="${p.id}">Team</button>` : ''}
                </div>
             `;
        container.appendChild(card);
      });

      // Attach events
      document.querySelectorAll('.edit-btn').forEach(b => {
        b.onclick = (e) => openEditModal(e.target.dataset.id);
      });
      document.querySelectorAll('.team-btn').forEach(b => {
        b.onclick = (e) => openTeamModal(e.target.dataset.id); // Re-using meetings modal logic for simplicity in this pass, or new logic
      });
    }

    // --- Modal Logic (Unified for simplicity) ---
    // Project Create
    const modal = document.getElementById('projectModal');
    document.getElementById('addProjectBtn').onclick = () => {
      document.getElementById('projectName').value = '';
      document.getElementById('newProgressSlider').value = 0;
      document.getElementById('newProjectProgress').textContent = '0';
      document.getElementById('colleaguesInputs').innerHTML = `
            <div class="colleague-row" style="display:flex; gap:10px; margin-bottom:10px;">
                <input placeholder="Name" class="colName" /><input placeholder="Email" class="colEmail" type="email" />
            </div>`;
      modal.style.display = 'flex';
    };
    document.getElementById('closeModalBtn').onclick = () => modal.style.display = 'none';

    document.getElementById('addColleagueBtn').onclick = () => {
      const div = document.createElement('div');
      div.className = 'colleague-row';
      div.style.cssText = "display:flex; gap:10px; margin-bottom:10px;";
      div.innerHTML = `<input placeholder="Name" class="colName" /><input placeholder="Email" class="colEmail" type="email" /><button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;">×</button>`;
      document.getElementById('colleaguesInputs').appendChild(div);
    };

    document.getElementById('saveProjectBtn').onclick = async () => {
      const name = document.getElementById('projectName').value;
      const progress = document.getElementById('newProgressSlider').value;
      const cols = [];
      document.querySelectorAll('#colleaguesInputs .colleague-row').forEach(Row => {
        const n = Row.querySelector('.colName').value;
        const e = Row.querySelector('.colEmail').value;
        if (n && e) cols.push({ name: n, email: e });
      });

      if (!name) return alert('Name required');

      await apiCall('/projects', {
        method: 'POST', body: JSON.stringify({
          name, owner_email: userEmail, colleagues: JSON.stringify(cols), progress
        })
      });
      modal.style.display = 'none';
      loadProjects();
    };

    // Sliders
    document.querySelectorAll('input[type=range]').forEach(i => {
      i.oninput = (e) => {
        e.target.previousElementSibling.querySelector('span').textContent = e.target.value;
      }
    });

    // Edit Modal
    const editModal = document.getElementById('editProjectModal');
    function openEditModal(id) {
      const p = projects.find(x => x.id == id);
      if (!p) return;
      editingProjectId = id;
      document.getElementById('editProjectName').value = p.name;
      document.getElementById('editProgressSlider').value = p.progress || 0;
      document.getElementById('editProjectProgress').textContent = p.progress || 0;

      let cols = [];
      try { cols = typeof p.colleagues === 'string' ? JSON.parse(p.colleagues) : p.colleagues || []; } catch (e) { }

      const container = document.getElementById('editColleaguesInputs');
      container.innerHTML = '';
      cols.forEach(c => {
        const div = document.createElement('div');
        div.className = 'colleague-row';
        div.style.cssText = "display:flex; gap:10px; margin-bottom:10px;";
        div.innerHTML = `<input placeholder="Name" class="editColName" value="${c.name}" /><input placeholder="Email" class="editColEmail" type="email" value="${c.email}" /><button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;">×</button>`;
        container.appendChild(div);
      });
      if (cols.length === 0) {
        const div = document.createElement('div');
        div.className = 'colleague-row';
        div.style.cssText = "display:flex; gap:10px; margin-bottom:10px;";
        div.innerHTML = `<input placeholder="Name" class="editColName" /><input placeholder="Email" class="editColEmail" type="email" />`;
        container.appendChild(div);
      }

      editModal.style.display = 'flex';
    }

    document.getElementById('closeEditModalBtn').onclick = () => editModal.style.display = 'none';
    document.getElementById('updateProjectBtn').onclick = async () => {
      const name = document.getElementById('editProjectName').value;
      const progress = document.getElementById('editProgressSlider').value;
      const cols = [];
      document.querySelectorAll('#editColleaguesInputs .colleague-row').forEach(Row => {
        const n = Row.querySelector('.editColName').value;
        const e = Row.querySelector('.editColEmail').value;
        if (n && e) cols.push({ name: n, email: e });
      });

      await apiCall(`/projects/${editingProjectId}`, {
        method: 'PUT', body: JSON.stringify({
          name, colleagues: JSON.stringify(cols), progress
        })
      });
      editModal.style.display = 'none';
      loadProjects();
    };

    document.getElementById('deleteProjectBtn').onclick = async () => {
      if (confirm('Delete project?')) {
        await apiCall(`/projects/${editingProjectId}`, { method: 'DELETE' });
        editModal.style.display = 'none';
        loadProjects();
      }
    }

    document.getElementById('editAddColleagueBtn').onclick = () => {
      const div = document.createElement('div');
      div.className = 'colleague-row';
      div.style.cssText = "display:flex; gap:10px; margin-bottom:10px;";
      div.innerHTML = `<input placeholder="Name" class="editColName" /><input placeholder="Email" class="editColEmail" type="email" /><button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;">×</button>`;
      document.getElementById('editColleaguesInputs').appendChild(div);
    };

    // Search
    searchBar.oninput = (e) => renderProjects(e.target.value);

    // Logout
    document.getElementById('logoutBtn').onclick = (e) => {
      e.preventDefault();
      sessionStorage.clear();
      window.location.href = 'index.html';
    }

    // --- Meetings Logic (opening simplified) ---
    const meetingsModal = document.getElementById('meetingsModal');
    function openTeamModal(id) {
      // Identify project
      const p = projects.find(x => x.id == id);
      // For simplistic "Meetings", show list of members and allow clicking them? 
      // Or just show all meetings? The previous code was complex. 
      // Let's list the members and allow adding meetings to them.
      // Effectively, just opening the meetings modal for the first colleague found or listing them.
      // Let's just list all meetings for all colleagues in this project.

      let cols = typeof p.colleagues === 'string' ? JSON.parse(p.colleagues) : p.colleagues || [];
      if (cols.length === 0) return alert('No team members.');

      meetingsModal.style.display = 'flex';
      loadAllMeetings(cols);
    }

    document.getElementById('closeMeetingsModalBtn').onclick = () => meetingsModal.style.display = 'none';

    async function loadAllMeetings(colleagues) {
      const list = document.getElementById('meetingsList');
      list.innerHTML = 'Loading...';
      let html = '';

      // Populate select dropdown for adding new meeting?
      // We need a way to select which colleague to add a note for.
      // For now, let's just pick the first one as default or add a selector.

      // To keep it simple: Just list interactions.
      for (let c of colleagues) {
        try {
          const m = await apiCall(`/meetings/${encodeURIComponent(c.email)}`);
          if (m.length) {
            html += `<div style="margin-bottom:10px; font-weight:bold; color:var(--accent-tertiary);">${c.name}</div>`;
            m.forEach(meet => {
              html += `<div style="font-size:0.9rem; padding-left:10px; border-left:2px solid var(--border-color); margin-bottom:5px;">
                            <span style="color:var(--text-secondary); font-size:0.8rem;">${new Date(meet.date).toLocaleDateString()}</span>: ${meet.description}
                        </div>`;
            });
          }
        } catch (e) { }
      }

      if (!html) html = 'No meeting notes found.';

      // Add a "quick add" selector
      html = `<div style="margin-bottom:15px;">
            <label style="font-size:0.8rem;">Add note for:</label>
            <select id="meetingColleagueSelect" style="width:100%; padding:5px;">
                ${colleagues.map(c => `<option value="${c.email}">${c.name}</option>`).join('')}
            </select>
        </div>` + html;

      list.innerHTML = html;
    }

    document.getElementById('addMeetingBtn').onclick = async () => {
      const email = document.getElementById('meetingColleagueSelect').value;
      const date = document.getElementById('meetingDate').value;
      const desc = document.getElementById('meetingDesc').value;

      if (!email || !date || !desc) return alert('All fields required');

      await apiCall('/meetings', {
        method: 'POST', body: JSON.stringify({
          colleague_email: email, date, description: desc
        })
      });

      // Reload
      // Ideally we re-fetch context. For now just alert.
      alert('Note added');
      meetingsModal.style.display = 'none';
    };

    // Init
    loadProjects();

  </script>
</body>

</html>